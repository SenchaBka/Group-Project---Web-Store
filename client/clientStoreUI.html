<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Store App</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="styles/styles.css">

    <link rel="icon" type="image/x-icon" href="/images/logo.ico">
</head>

<body>
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
        <div class="container-fluid">
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="login.html">Log in</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="index.html">Store</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="clientStoreUI.html">Your products</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="profile.html">Profile</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main>
        <form id="addItemForm">
            <h2>Add Item</h2>
            <label for="itemName">Item Name:</label><br>
            <input type="text" id="itemName" name="itemName" required><br>
            <label for="itemPrice">Item Description:</label><br>
            <input type="text" id="itemDesc" name="itemDesc" required><br>
            <label for="itemPrice">Item Price:</label><br>
            <input type="text" id="itemPrice" name="itemPrice" required><br>
            <input type="submit" value="Submit">
        </form>

        <!-- Add an edit form, initially hidden -->
        <form id="editItemForm" style="display: none;">
            <h2>Edit Item</h2>
            <input type="hidden" id="editItemId" name="editItemId">
            <label for="editItemName">Item Name:</label><br>
            <input type="text" id="editItemName" name="editItemName" required><br>
            <label for="editItemDesc">Item Description:</label><br>
            <input type="text" id="editItemDesc" name="editItemDesc" required><br>
            <label for="editItemPrice">Item Price:</label><br>
            <input type="text" id="editItemPrice" name="editItemPrice" required><br>
            <input type="button" value="Update" onclick="updateItem()">
        </form>

        <p>Your items:</p>
        <ul id="items-list"></ul>
        <button onclick="showUserItems()">Show My Items</button>


        <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>

        <script>
            var firebaseConfig = {
                apiKey: "AIzaSyAve3Kdp7vBhqt0E6BA0fWpbOSCxIqOCls",
                authDomain: "week11-1-6c138.firebaseapp.com",
                projectId: "week11-1-6c138",
                storageBucket: "week11-1-6c138.appspot.com",
                messagingSenderId: "753661187204",
                appId: "1:753661187204:web:94e664f28ed4119a0e9ed1",
                measurementId: "G-LK84KM2HT8"
            };
            // Existing Firebase initialization
            firebase.initializeApp(firebaseConfig);
            var db = firebase.firestore();

            // Initialize Firebase Authentication
            var auth = firebase.auth();

            document.getElementById('addItemForm').addEventListener('submit', function (e) {
                e.preventDefault();
                var itemsList = document.getElementById('items-list');

                var user = auth.currentUser;
                if (user) {
                    itemsList.innerHTML = "Item added successfully";
                    // User is signed in, allow them to add items
                    var itemName = document.getElementById('itemName').value;
                    var itemDesc = document.getElementById('itemDesc').value;
                    var itemPrice = document.getElementById('itemPrice').value;

                    db.collection("items").add({
                        name: itemName,
                        price: itemPrice,
                        description: itemDesc,
                        userId: user.uid
                    })
                } else {
                    itemsList.innerHTML = "Error. You have to log in";
                }
            });

            function showUserItems() {
                var itemsList = document.getElementById('items-list');
                itemsList.innerHTML = ""; // Clear existing items in the list
                var user = auth.currentUser;
                if (user) {
                    // Listen for real-time updates on the items collection for the current user
                    db.collection("items").where("userId", "==", user.uid).onSnapshot((querySnapshot) => {
                        querySnapshot.forEach((doc) => {
                            const itemData = doc.data();
                            const listItem = document.createElement('li');
                            listItem.textContent = doc.data().name + " - " + doc.data().description + ' - ' + doc.data().price + "$";

                            itemsList.appendChild(listItem);

                            // Add an edit button for each item
                            const editButton = document.createElement('button');
                            editButton.textContent = 'Edit';
                            editButton.addEventListener('click', () => showEditForm(doc.id, itemData));

                            // Add a delete button for each item
                            const deleteButton = document.createElement('button');
                            deleteButton.textContent = 'Delete';
                            deleteButton.addEventListener('click', () => deleteItem(doc.id));

                            listItem.appendChild(editButton);
                            listItem.appendChild(deleteButton);
                        });
                    }, (error) => {
                        console.error("Error getting items:", error.message);
                    });
                }

                function deleteItem(itemId) {
                    db.collection("items").doc(itemId).delete()
                        .then(() => {
                            showUserItems();
                            itemsList.append("Item deleted successfully");
                        })
                        .catch((error) => {
                            console.error("Error deleting item: ", error);
                        });
                }
            }

            // Function to show the edit form for an item
            function showEditForm(itemId, itemData) {
                var editForm = document.getElementById('editItemForm');
                editForm.style.display = 'block';
                document.getElementById("addItemForm").style.display = "none";

                // Populate the form with existing item data
                editForm.elements['editItemId'].value = itemId;
                editForm.elements['editItemName'].value = itemData.name;
                editForm.elements['editItemDesc'].value = itemData.description;
                editForm.elements['editItemPrice'].value = itemData.price;
            }

            function updateItem() {
                var editForm = document.getElementById('editItemForm');
                var itemId = editForm.elements['editItemId'].value;
                var itemName = editForm.elements['editItemName'].value;
                var itemDesc = editForm.elements['editItemDesc'].value;
                var itemPrice = editForm.elements['editItemPrice'].value;

                db.collection("items").doc(itemId).update({
                    name: itemName,
                    description: itemDesc,
                    price: itemPrice,
                })
                    .then(() => {
                        console.log("Item updated successfully");
                        // After updating the item, hide the edit form and refresh the displayed items
                        editForm.style.display = 'none';
                        document.getElementById("addItemForm").style.display = "block";
                        showUserItems();
                    })
                    .catch((error) => {
                        console.error("Error updating item: ", error);
                    });
            }
        </script>
    </main>
</body>

</html>